<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Direto do Loader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        #logs {
            background: #000;
            color: #0f0;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        #emulator-container {
            width: 320px;
            height: 240px;
            border: 1px solid #333;
            margin: 10px 0;
            background: #222;
        }
        button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #555;
        }
        .status {
            padding: 5px;
            margin: 5px 0;
            border-radius: 3px;
        }
        .success { background: #004400; }
        .error { background: #440000; }
        .warning { background: #444400; }
    </style>
</head>
<body>
    <h1>üîß Teste Direto do Loader EmulatorJS</h1>
    
    <div id="status" class="status">Aguardando...</div>
    
    <div id="logs"></div>
    
    <div>
        <button onclick="testLoader()">Testar Loader</button>
        <button onclick="testWithRom()">Testar com ROM</button>
        <button onclick="clearLogs()">Limpar Logs</button>
    </div>
    
    <div id="emulator-container"></div>
    
    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#0f0',
                error: '#f00',
                warning: '#ff0',
                success: '#0f0'
            };
            
            logCount++;
            logs.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${logCount}: ${message}</span>\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function setStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            logCount = 0;
        }
        
        // Interceptar erros globais
        window.addEventListener('error', function(e) {
            log(`‚ùå Erro global: ${e.message} em ${e.filename}:${e.lineno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            log(`‚ùå Promise rejeitada: ${e.reason}`, 'error');
        });
        
        function testLoader() {
            log('üöÄ Iniciando teste do loader...', 'info');
            setStatus('Testando loader...', 'warning');
            
            try {
                // Limpar estado anterior
                if (window.EJS_emulator) {
                    log('üóëÔ∏è Removendo EJS_emulator anterior', 'info');
                    delete window.EJS_emulator;
                }
                
                // Configurar vari√°veis globais
                window.EJS_player = '#emulator-container';
                window.EJS_core = 'segaMD';
                window.EJS_pathtodata = '/emulatorjs-data/';
                window.EJS_startOnLoaded = true;
                
                log('‚úÖ Vari√°veis configuradas:', 'success');
                log(`   EJS_player: ${window.EJS_player}`, 'info');
                log(`   EJS_core: ${window.EJS_core}`, 'info');
                log(`   EJS_pathtodata: ${window.EJS_pathtodata}`, 'info');
                
                // Callback de prontid√£o
                window.EJS_ready = function() {
                    log('üéâ EJS_ready executado!', 'success');
                    setStatus('EJS_ready executado!', 'success');
                    
                    if (window.EJS_emulator) {
                        log('‚úÖ EJS_emulator dispon√≠vel', 'success');
                        log(`   Tipo: ${typeof window.EJS_emulator}`, 'info');
                        
                        try {
                            const methods = Object.getOwnPropertyNames(window.EJS_emulator);
                            log(`   M√©todos (${methods.length}): ${methods.slice(0, 10).join(', ')}${methods.length > 10 ? '...' : ''}`, 'info');
                            const gm = window.EJS_emulator.gameManager;
                            if (gm) {
                                log(`   GM.Module: ${!!gm.Module} GM.FS: ${!!gm.FS} GM.functions: ${!!gm.functions}`, 'info');
                                if (gm.Module) {
                                    const keys = Object.keys(gm.Module);
                                    log(`   GM.Module keys (amostra): ${keys.slice(0,20).join(', ')}${keys.length>20?'...':''}`, 'info');
                                }
                            }
                        } catch (e) {
                            log(`   Erro ao listar m√©todos: ${e.message}`, 'warning');
                        }
                    } else {
                        log('‚ùå EJS_emulator ainda n√£o dispon√≠vel', 'error');
                    }
                };
                
                // Guarda para n√£o reinjetar m√∫ltiplas vezes
                const existingScript = document.querySelector('script[data-ejs-loader]');
                if (existingScript) {
                    log('‚úÖ loader.js j√° presente, n√£o reinjetar', 'warning');
                    if (!window.EJS_emulator && typeof window.EmulatorJS === 'function') {
                        log('‚öôÔ∏è Instanciando EmulatorJS manualmente (loader reutilizado)', 'info');
                        const config = {
                            gameUrl: window.EJS_gameUrl,
                            dataPath: window.EJS_pathtodata,
                            system: window.EJS_core,
                            startOnLoad: window.EJS_startOnLoaded,
                            fullscreenOnLoad: window.EJS_fullscreenOnLoaded,
                            filePaths: window.EJS_paths,
                            threads: window.EJS_threads,
                            forceLegacyCores: window.EJS_forceLegacyCores,
                        };
                        // eslint-disable-next-line no-new
                        window.EJS_emulator = new window.EmulatorJS(window.EJS_player, config);
                        if (typeof window.EJS_ready === 'function') window.EJS_emulator.on('ready', window.EJS_ready);
                    }
                }
                
                // Carregar loader.js
                log('üì• Carregando loader.js...', 'info');
                const script = document.createElement('script');
                script.src = '/emulatorjs-data/loader.js';
                script.async = true;
                script.dataset.ejsLoader = 'true';
                
                script.onload = function() {
                    log('‚úÖ loader.js carregado', 'success');
                    setStatus('Loader carregado, aguardando emulador...', 'warning');
                    
                    // Monitorar EJS_emulator
                    let attempts = 0;
                    const maxAttempts = 100;
                    
                    const checkEmulator = setInterval(() => {
                        attempts++;
                        
                        if (window.EJS_emulator) {
                            clearInterval(checkEmulator);
                            log(`üéÆ EJS_emulator criado ap√≥s ${attempts} tentativas!`, 'success');
                            setStatus('Emulador inicializado com sucesso!', 'success');
                            
                            try {
                                log(`   Constructor: ${window.EJS_emulator.constructor.name}`, 'info');
                                log(`   Prototype: ${Object.getPrototypeOf(window.EJS_emulator).constructor.name}`, 'info');
                            } catch (e) {
                                log(`   Erro ao analisar constructor: ${e.message}`, 'warning');
                            }
                            
                        } else if (attempts >= maxAttempts) {
                            clearInterval(checkEmulator);
                            log(`‚ùå Timeout ap√≥s ${attempts} tentativas`, 'error');
                            setStatus('Timeout: Emulador n√£o inicializou', 'error');
                        } else if (attempts % 10 === 0) {
                            log(`‚è≥ Tentativa ${attempts}/${maxAttempts}...`, 'info');
                        }
                    }, 100);
                };
                
                script.onerror = function(e) {
                    log(`‚ùå Erro ao carregar loader.js: ${e.message || 'Erro desconhecido'}`, 'error');
                    setStatus('Erro ao carregar loader', 'error');
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                log(`‚ùå Erro durante teste: ${error.message}`, 'error');
                setStatus('Erro durante teste', 'error');
            }
        }
        
        async function testWithRom() {
            log('üéÆ Testando com ROM...', 'info');
            
            if (!window.EJS_emulator) {
                log('‚ùå EJS_emulator n√£o dispon√≠vel. Execute "Testar Loader" primeiro.', 'error');
                return;
            }
            
            try {
                // Configurar eventos do emulador
                if (typeof window.EJS_emulator.on === 'function') {
                    window.EJS_emulator.on('gameLoaded', () => {
                        log('üéâ Evento gameLoaded disparado!', 'success');
                    });
                    
                    window.EJS_emulator.on('error', (error) => {
                        log(`‚ùå Evento error: ${error}`, 'error');
                    });
                    
                    window.EJS_emulator.on('saveDatabaseLoaded', (fs) => {
                        log('üíæ Sistema de arquivos carregado', 'success');
                        log(`   FS dispon√≠vel: ${!!fs}`, 'info');
                    });
                }
                
                // Espera Module estar dispon√≠vel (initModule conclu√≠do)
                let attempts = 0;
                while ((!window.EJS_emulator.Module) && attempts < 200) {
                    await new Promise(r => setTimeout(r, 100));
                    attempts++;
                    if (attempts % 20 === 0) log(`‚è≥ Aguardando Module... (${attempts}/200)`, 'info');
                }
                if (!window.EJS_emulator.Module) {
                    log('‚ùå Timeout aguardando Module', 'error');
                    return;
                }

                // Configurar ROM
                window.EJS_gameUrl = '/data/rom_teste.bin';
                log(`üìÅ ROM configurada: ${window.EJS_gameUrl}`, 'info');
                
                if (typeof window.EJS_emulator.downloadFiles === 'function') {
                    log('üì• Disparando downloadFiles...', 'info');
                    window.EJS_emulator.downloadFiles();
                    log('‚úÖ downloadFiles disparado', 'success');
                    
                    // Monitorar se o jogo foi carregado
                    let checkAttempts = 0;
                    const checkGameLoaded = setInterval(() => {
                        checkAttempts++;
                        
                        if (window.EJS_emulator.gameManager) {
                            clearInterval(checkGameLoaded);
                            log(`üéÆ GameManager criado ap√≥s ${checkAttempts} verifica√ß√µes!`, 'success');
                            
                            if (window.EJS_emulator.gameManager.FS) {
                                log('üìÇ Sistema de arquivos dispon√≠vel', 'success');
                            }
                        } else if (checkAttempts > 50) {
                            clearInterval(checkGameLoaded);
                            log('‚è∞ Timeout aguardando GameManager', 'warning');
                        }
                    }, 200);
                    
                } else {
                    log('‚ùå downloadFiles n√£o √© uma fun√ß√£o', 'error');
                    log(`   Tipo: ${typeof window.EJS_emulator.downloadFiles}`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao testar ROM: ${error.message}`, 'error');
            }
        }
        
        log('üìã P√°gina carregada. Clique em "Testar Loader" para come√ßar.', 'info');
        setStatus('Pronto para teste', 'success');
    </script>
</body>
</html>