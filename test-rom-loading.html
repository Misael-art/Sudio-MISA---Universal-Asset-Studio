<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Carregamento de ROM Real - Genesis Plus GX</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
        }
        .warning {
            border-left-color: #ff9800;
        }
        .log {
            background-color: #000;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.success { background-color: #4CAF50; }
        .status.error { background-color: #f44336; }
        .status.warning { background-color: #ff9800; }
        .status.info { background-color: #2196F3; }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .memory-data {
            background-color: #333;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .hex-dump {
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Teste de Carregamento de ROM Real - Fase 0</h1>
        
        <div class="test-section">
            <h2>üìã Status do Teste</h2>
            <div id="status">Aguardando in√≠cio do teste...</div>
            <button onclick="startRomTest()">Iniciar Teste de ROM</button>
            <button onclick="clearLog()">Limpar Log</button>
        </div>

        <div class="test-section">
            <h2>üéØ Carregamento da ROM</h2>
            <div id="rom-status">Nenhuma ROM carregada ainda.</div>
            <div id="rom-info"></div>
        </div>

        <div class="test-section">
            <h2>üß† Extra√ß√£o de Dados de Mem√≥ria</h2>
            <div id="memory-extraction">Aguardando carregamento da ROM...</div>
            <div id="memory-data"></div>
        </div>

        <div class="test-section">
            <h2>üìä Valida√ß√£o dos Dados</h2>
            <div id="validation-results">Aguardando extra√ß√£o de dados...</div>
        </div>

        <div class="test-section">
            <h2>üìù Log Detalhado</h2>
            <div id="log" class="log">Aguardando in√≠cio dos testes...
</div>
        </div>
    </div>

    <script>
        let logElement;
        let statusElement;
        let romStatusElement;
        let romInfoElement;
        let memoryExtractionElement;
        let memoryDataElement;
        let validationElement;
        let emulatorModule = null;
        let gameManager = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': 'üìù',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            }[type] || 'üìù';
            
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            statusElement.innerHTML = `<span class="status ${type}">${message}</span>`;
        }

        function clearLog() {
            logElement.textContent = 'Log limpo.\n';
        }

        function formatHexDump(data, maxBytes = 64) {
            let result = '';
            const bytes = Math.min(data.length, maxBytes);
            
            for (let i = 0; i < bytes; i += 16) {
                const offset = i.toString(16).padStart(4, '0').toUpperCase();
                let hexPart = '';
                let asciiPart = '';
                
                for (let j = 0; j < 16 && (i + j) < bytes; j++) {
                    const byte = data[i + j];
                    hexPart += byte.toString(16).padStart(2, '0').toUpperCase() + ' ';
                    asciiPart += (byte >= 32 && byte <= 126) ? String.fromCharCode(byte) : '.';
                }
                
                result += `${offset}: ${hexPart.padEnd(48)} |${asciiPart}|\n`;
            }
            
            if (data.length > maxBytes) {
                result += `... (${data.length - maxBytes} bytes restantes)\n`;
            }
            
            return result;
        }

        async function startRomTest() {
            logElement = document.getElementById('log');
            statusElement = document.getElementById('status');
            romStatusElement = document.getElementById('rom-status');
            romInfoElement = document.getElementById('rom-info');
            memoryExtractionElement = document.getElementById('memory-extraction');
            memoryDataElement = document.getElementById('memory-data');
            validationElement = document.getElementById('validation-results');

            updateStatus('Iniciando teste de carregamento de ROM...', 'info');
            log('üöÄ Iniciando teste de carregamento de ROM real');
            
            try {
                // 1. Carregar EmulatorJS
                log('üì¶ Carregando EmulatorJS...');
                await loadEmulatorJS();
                
                // 2. Carregar ROM de teste
                log('üéÆ Carregando ROM de teste...');
                await loadTestRom();
                
                // 3. Aguardar inicializa√ß√£o
                log('‚è≥ Aguardando inicializa√ß√£o do emulador...');
                await waitForEmulatorReady();
                
                // 4. Extrair dados de mem√≥ria
                log('üß† Extraindo dados de mem√≥ria...');
                await extractMemoryData();
                
                // 5. Validar dados
                log('‚úÖ Validando dados extra√≠dos...');
                validateExtractedData();
                
                updateStatus('Teste de ROM conclu√≠do com sucesso', 'success');
                
            } catch (error) {
                log(`‚ùå Erro durante o teste: ${error.message}`, 'error');
                updateStatus('Erro no teste de ROM', 'error');
            }
        }

        async function loadEmulatorJS() {
            return new Promise((resolve, reject) => {
                // Carregar loader.js do EmulatorJS
                const script = document.createElement('script');
                script.src = '/emulatorjs-data/loader.js';
                script.onload = () => {
                    log('‚úÖ EmulatorJS loader carregado');
                    resolve();
                };
                script.onerror = () => {
                    reject(new Error('Falha ao carregar EmulatorJS loader'));
                };
                document.head.appendChild(script);
            });
        }

        async function loadTestRom() {
            return new Promise(async (resolve, reject) => {
                try {
                    // Buscar ROM de teste
                    const response = await fetch('/data/rom_teste.bin');
                    if (!response.ok) {
                        throw new Error(`Falha ao carregar ROM: ${response.status}`);
                    }
                    
                    const romData = await response.arrayBuffer();
                    log(`‚úÖ ROM carregada: ${romData.byteLength} bytes`);
                    
                    romStatusElement.innerHTML = `
                        <div style="color: #4CAF50;">‚úÖ ROM carregada com sucesso</div>
                        <div>Tamanho: ${romData.byteLength} bytes (${(romData.byteLength / 1024).toFixed(1)} KB)</div>
                    `;
                    
                    // Analisar header da ROM
                    const header = new Uint8Array(romData.slice(0, 512));
                    let romInfo = '<h3>Informa√ß√µes da ROM:</h3>';
                    
                    // Verificar assinatura Mega Drive
                    const headerText = new TextDecoder('ascii').decode(header.slice(256, 272));
                    romInfo += `<div>Header: ${headerText.trim()}</div>`;
                    
                    // Verificar regi√£o
                    const region = String.fromCharCode(header[496]);
                    romInfo += `<div>Regi√£o: ${region}</div>`;
                    
                    romInfoElement.innerHTML = romInfo;
                    
                    // Configurar EmulatorJS
                    window.EJS_player = '#emulator-container';
                    window.EJS_core = 'genplusgx';
                    window.EJS_gameUrl = '/data/rom_teste.bin';
                    window.EJS_pathtodata = '/emulatorjs-data/';
                    
                    // Criar container do emulador
                    let container = document.getElementById('emulator-container');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'emulator-container';
                        container.style.width = '320px';
                        container.style.height = '240px';
                        container.style.display = 'none'; // Ocultar para teste
                        document.body.appendChild(container);
                    }
                    
                    log('üéÆ Inicializando emulador...');
                    resolve();
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function waitForEmulatorReady() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 30; // 30 segundos
                
                const checkReady = () => {
                    attempts++;
                    
                    if (window.EJS_emulator && window.EJS_emulator.gameManager) {
                        gameManager = window.EJS_emulator.gameManager;
                        log('‚úÖ Emulador inicializado e pronto');
                        resolve();
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        reject(new Error('Timeout aguardando inicializa√ß√£o do emulador'));
                        return;
                    }
                    
                    log(`‚è≥ Aguardando emulador... (${attempts}/${maxAttempts})`);
                    setTimeout(checkReady, 1000);
                };
                
                checkReady();
            });
        }

        async function extractMemoryData() {
            if (!gameManager || !gameManager.Module) {
                throw new Error('GameManager ou Module n√£o dispon√≠vel');
            }
            
            const module = gameManager.Module;
            let extractionResults = '<h3>Resultados da Extra√ß√£o:</h3>';
            let memoryData = '';
            
            // Testar cada ponteiro de mem√≥ria
            const memoryRegions = [
                { name: 'VRAM', getter: '_get_vram_ptr', alt: 'get_vram_ptr', size: 65536 },
                { name: 'CRAM', getter: '_get_cram_ptr', alt: 'get_cram_ptr', size: 128 },
                { name: 'VSRAM', getter: '_get_vsram_ptr', alt: 'get_vsram_ptr', size: 80 },
                { name: 'SAT', getter: '_get_sat_ptr', alt: 'get_sat_ptr', size: 640 },
                { name: 'VDP_REGS', getter: '_get_vdp_regs_ptr', alt: 'get_vdp_regs_ptr', size: 32 }
            ];
            
            for (const region of memoryRegions) {
                try {
                    let fn = null;
                    
                    // Tentar encontrar a fun√ß√£o
                    if (module[region.getter]) {
                        fn = module[region.getter];
                    } else if (module[region.alt]) {
                        fn = module[region.alt];
                    } else if (module.cwrap) {
                        try {
                            fn = module.cwrap(region.getter, 'number', []);
                        } catch (e) {
                            try {
                                fn = module.cwrap(region.alt, 'number', []);
                            } catch (e2) {
                                // Ignore
                            }
                        }
                    }
                    
                    if (fn && typeof fn === 'function') {
                        const ptr = fn();
                        
                        if (ptr && ptr > 0) {
                            // Extrair dados
                            const data = new Uint8Array(module.HEAPU8.buffer, ptr, region.size);
                            const dataCopy = new Uint8Array(data); // C√≥pia para an√°lise
                            
                            // Verificar se cont√©m dados n√£o-zero
                            const nonZeroBytes = dataCopy.filter(b => b !== 0).length;
                            const dataPercentage = ((nonZeroBytes / dataCopy.length) * 100).toFixed(1);
                            
                            extractionResults += `
                                <div style="color: #4CAF50; margin: 10px 0;">
                                    ‚úÖ ${region.name}: 0x${ptr.toString(16)} (${dataCopy.length} bytes)
                                    <br>&nbsp;&nbsp;&nbsp;Dados n√£o-zero: ${nonZeroBytes}/${dataCopy.length} (${dataPercentage}%)
                                </div>
                            `;
                            
                            // Adicionar hex dump
                            memoryData += `\n=== ${region.name} (primeiros 64 bytes) ===\n`;
                            memoryData += formatHexDump(dataCopy, 64);
                            
                            log(`‚úÖ ${region.name} extra√≠do: ${nonZeroBytes}/${dataCopy.length} bytes n√£o-zero (${dataPercentage}%)`, 'success');
                            
                        } else {
                            extractionResults += `<div style="color: #f44336;">‚ùå ${region.name}: ponteiro nulo (${ptr})</div>`;
                            log(`‚ùå ${region.name}: ponteiro nulo`, 'error');
                        }
                    } else {
                        extractionResults += `<div style="color: #f44336;">‚ùå ${region.name}: fun√ß√£o n√£o encontrada</div>`;
                        log(`‚ùå ${region.name}: fun√ß√£o n√£o encontrada`, 'error');
                    }
                    
                } catch (error) {
                    extractionResults += `<div style="color: #f44336;">‚ùå ${region.name}: erro - ${error.message}</div>`;
                    log(`‚ùå Erro ao extrair ${region.name}: ${error.message}`, 'error');
                }
            }
            
            memoryExtractionElement.innerHTML = extractionResults;
            memoryDataElement.innerHTML = `<div class="memory-data"><div class="hex-dump">${memoryData}</div></div>`;
        }

        function validateExtractedData() {
            let validationResults = '<h3>Valida√ß√£o dos Dados:</h3>';
            
            // Verificar se os dados extra√≠dos s√£o v√°lidos
            const memoryDataDiv = memoryDataElement.querySelector('.hex-dump');
            const hasMemoryData = memoryDataDiv && memoryDataDiv.textContent.length > 100;
            
            if (hasMemoryData) {
                validationResults += '<div style="color: #4CAF50;">‚úÖ Dados de mem√≥ria extra√≠dos com sucesso</div>';
                validationResults += '<div style="color: #4CAF50;">‚úÖ Hex dumps gerados corretamente</div>';
                
                // Verificar se h√° dados n√£o-zero
                const extractionDiv = memoryExtractionElement;
                const hasNonZeroData = extractionDiv.innerHTML.includes('n√£o-zero:');
                
                if (hasNonZeroData) {
                    validationResults += '<div style="color: #4CAF50;">‚úÖ Dados n√£o-zero detectados nas regi√µes de mem√≥ria</div>';
                    validationResults += '<div style="color: #4CAF50;">üéâ TESTE APROVADO: ROM carregada e dados extra√≠dos com sucesso!</div>';
                    log('üéâ VALIDA√á√ÉO APROVADA: Carregamento de ROM e extra√ß√£o de dados funcionando corretamente', 'success');
                } else {
                    validationResults += '<div style="color: #ff9800;">‚ö†Ô∏è Apenas dados zero detectados - pode indicar ROM n√£o inicializada</div>';
                    log('‚ö†Ô∏è VALIDA√á√ÉO PARCIAL: Dados extra√≠dos mas apenas zeros detectados', 'warning');
                }
            } else {
                validationResults += '<div style="color: #f44336;">‚ùå Falha na extra√ß√£o de dados de mem√≥ria</div>';
                validationResults += '<div style="color: #f44336;">‚ùå TESTE REPROVADO: N√£o foi poss√≠vel extrair dados v√°lidos</div>';
                log('‚ùå VALIDA√á√ÉO REPROVADA: Falha na extra√ß√£o de dados de mem√≥ria', 'error');
            }
            
            validationElement.innerHTML = validationResults;
        }
    </script>
</body>
</html>