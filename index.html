<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Universal Asset Studio - Genesis Plus GX Core Tester</title>
    <meta name="description" content="Universal Asset Studio - Fase 1: Valida√ß√£o do core Genesis Plus GX e captura de mem√≥ria" />
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Implementando Fase 1: Carregamento local do Genesis Plus GX -->
    <!-- Seguindo o princ√≠pio de "Confian√ßa Zero" - sem depend√™ncias de CDN -->
    <script>
      // Configura√ß√£o global para o m√≥dulo Emscripten
      // Prepara√ß√£o para carregamento do core Genesis Plus GX
      window.Module = {
        locateFile: function(path) {
          console.log('[MODULE] locateFile chamado para:', path);
          // CORRE√á√ÉO CR√çTICA: Garante que o arquivo .wasm seja carregado do diret√≥rio correto
          if (path.endsWith('.wasm') || path === 'genesis_plus_gx.wasm' || path === 'genplusgx.wasm') {
            // Usar o arquivo WASM correto
            const wasmPath = '/emulatorjs-data/cores/genesis_plus_gx.wasm';
            console.log('[MODULE] ‚úÖ Redirecionando WASM para:', wasmPath);
            return wasmPath;
          }
          console.log('[MODULE] Mantendo caminho original:', path);
          return path;
        },
        onRuntimeInitialized: function() {
          console.log('[MODULE] ‚úÖ Genesis Plus GX runtime inicializado via index.html');
        },
        onAbort: function(what) {
          console.error('[MODULE] ‚ùå Genesis Plus GX abortou:', what);
        },
        print: function(text) {
          console.log('[MODULE] Genesis Plus GX:', text);
        },
        printErr: function(text) {
          console.error('[MODULE] Genesis Plus GX Error:', text);
        },
        // CORRE√á√ÉO ADICIONAL: Configura√ß√µes para evitar problemas de import
        wasmBinary: null, // For√ßa carregamento via locateFile
        instantiateWasm: undefined, // Usa o m√©todo padr√£o
        noInitialRun: false,
        noExitRuntime: true
      };
    </script>
    
    <!-- As classes storage e gamepad s√£o carregadas automaticamente pelo loader.js -->
    
    <!-- CORRE√á√ÉO CR√çTICA: Carregamento IMEDIATO do core Genesis Plus GX -->
    <!-- Garante que EJS_Runtime esteja dispon√≠vel ANTES de qualquer tentativa do EmulatorJS -->
    <script src="/emulatorjs-data/cores/genesis_plus_gx.js"></script>
    
    <!-- FALLBACK: Carregar tamb√©m o genplusgx.js como alternativa -->
    <script>
      // Definir EJS_Runtime a partir do Module se n√£o estiver definido
      if (typeof window.EJS_Runtime !== 'function' && typeof window.Module === 'function') {
        console.log('[PRELOAD] üîÑ Definindo EJS_Runtime a partir de Module');
        window.EJS_Runtime = window.Module;
      }
    </script>
    <script src="/emulatorjs-data/cores/genplusgx.js"></script>
    
    <!-- Verifica√ß√£o adicional para garantir que EJS_Runtime foi definido -->
    <script>
      console.log('[PRELOAD] ‚úÖ genesis_plus_gx.js carregado imediatamente');
      console.log('[PRELOAD] - EJS_Runtime dispon√≠vel:', typeof window.EJS_Runtime);
      console.log('[PRELOAD] - Module configurado:', typeof window.Module);
      
      // Verifica√ß√£o de compatibilidade WASM
      if (typeof WebAssembly === 'object') {
        console.log('[PRELOAD] ‚úÖ WebAssembly suportado');
      } else {
        console.error('[PRELOAD] ‚ùå WebAssembly n√£o suportado!');
      }
      
      // Fallback adicional caso o carregamento direto falhe
      if (typeof window.EJS_Runtime !== 'function') {
        console.warn('[PRELOAD] ‚ö†Ô∏è EJS_Runtime n√£o definido ap√≥s carregamento direto. Tentando fallback...');
        
        // Tentar carregar dinamicamente como backup
        const script = document.createElement('script');
        script.src = '/emulatorjs-data/cores/genesis_plus_gx.js';
        script.onload = () => {
          console.log('[PRELOAD] ‚úÖ Fallback bem-sucedido - EJS_Runtime:', typeof window.EJS_Runtime);
        };
        script.onerror = (e) => {
          console.error('[PRELOAD] ‚ùå Fallback falhou:', e);
        };
        document.head.appendChild(script);
      }
      
      // Interceptar erros de WebAssembly para debug
      const originalInstantiate = WebAssembly.instantiate;
      WebAssembly.instantiate = function(...args) {
        console.log('[WASM] Tentativa de instancia√ß√£o:', args[0] instanceof ArrayBuffer ? 'ArrayBuffer' : typeof args[0], args[1] ? 'com imports' : 'sem imports');
        return originalInstantiate.apply(this, args).catch(error => {
          console.error('[WASM] ‚ùå Erro na instancia√ß√£o:', error);
          throw error;
        });
      };
    </script>
    
    <!-- Carregamento do script principal do Vite -->
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
